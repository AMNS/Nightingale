DAB'S NIGHTINGALE DEVELOPMENT LOG for March 2013 amd after

(Most of the files in my Ngale Carbon code base have last modification dates of April or
May 2012; a few files are 2 June 2012, and it looks like that's the last source code I
share with David G. This document describes all changes to my own code base since then,
the earliest of which are dated 4 March 2013. It also describes initial work on the
"new" Cocoa Ngale -- I think.)

* CoreMidiUtils.cp: make DebugPrintf output more readable.
* Debug output is overwhelmed by messages of the form
      pL=1461: rect.l=288,r=294 paper.l=-20860,r=-20248
	...for every note (Sync?) played. Those messages shouldn't be written by default!! 
	Affects MIDIPlay.cp: #define PLDEBUG as 0.
* Fix horrible and dangerously confusing kludge for turning notehead graphs off/on:
	add #define for NOTEHEAD_GRAPH_WIDTH; make doNoteheadGraphs a global. Affects
	defs.h, vars.h, DrawNRGR, InitNightingale, SpaceTime.
* Initialize.cp: display all CNFG field values & errors detected in them in log file;
	if config.whichMIDI is illegal, set it to a legal value (like all other fields).
* SpaceHighLevel.cp: improve debug print stmts.
* Added "Set tempo to visible/invisible" to QuickChange. Affects Set.h, SetCommand.cp,
	Nightingale.rsrc.
* Increased the minimum legal value of config.lineLW from 1 to 5.
* Added back into the declaration of the Configuration struct the _noteScanEpsXD_ field,
	which had somehow been deleted, resulting in misalignment of fields read in,
	nonsensical complaints about illegal CNFG values, ledger lines too long, etc.
	Affects applicationTypes.h .
* Debug output for playback is excessive; disable some. Affects MIDIPlay.cp: #define
	CMDEBUG as 0.
* Remove code to check expiration date. Affects InitNightingale

===================================================================================

* Have Xcode 3.2 running on my MacBook (OS 10.6.x); Xcode 2.5 on my G5 (OS 10.5.x).
	What version was used for recent release versions? David says Xcode 2.5!

With a 2008 copy of code I had lying around:

* On MacBook: choose 10.5 Release as Active SDK & Configuration. Active Architecture is set
to ppc, & it looks like there's no way to change it. ??  Anyway, Clean (w/ both options
checked), Build => tries to compile 175 files; fails with:
	10,327 warnings
		99% for deprecated stuff, plus a few malformed '#pragma options', etc.
	149 fatal errors
		all are "Jump to case label", "Crosses initialization of" ...

Redo: Build (w/o clean) => tries to compile 15 files; fails with 1703 warnings, 149 errors.

/Developer/usr/bin/gcc-4.2 -x c++ -arch ppc -fmessage-length=0 -pipe -Wno-trigraphs -fpascal-strings
	-Os -mdynamic-no-pic -isysroot /Developer/SDKs/MacOSX10.5.sdk -mtune=G4 -fvisibility=hidden
	-fvisibility-inlines-hidden -mmacosx-version-min=10.5 -gdwarf-2
	-I/Users/donbyrd/NgaleDev/ngale2xcodeSummer08/build/Nightingale.build/Release/Nightingale.build/Nightingale.hmap
	-F/Users/donbyrd/NgaleDev/ngale2xcodeSummer08/build/Release -I/Users/donbyrd/NgaleDev/ngale2xcodeSummer08/build/Release/include
	-I/Users/donbyrd/NgaleDev/ngale2xcodeSummer08/build/Nightingale.build/Release/Nightingale.build/DerivedSources/ppc
	-I/Users/donbyrd/NgaleDev/ngale2xcodeSummer08/build/Nightingale.build/Release/Nightingale.build/DerivedSources
	-c /Users/donbyrd/NgaleDev/NgaleXcodeApril2012/src/CFilesBothEd/EssentialTools.cp
	-o /Users/donbyrd/NgaleDev/ngale2xcodeSummer08/build/Nightingale.build/Release/Nightingale.build/Objects-normal/ppc/EssentialTools.o


* On G5: choose Release as Active Configuration, Build => fails with 8256 warnings,
1 error ("pbxcp: EndianUtils.h: No such file or directory")

To get started, I just want to get thru compilation quickly; maybe set compiler options
to be less picky? But _how_ do I set them? I don't see any such thing in Xcode! ??
Another idea: get a version of the code that's known to compile -- hey, maybe even the
latest from David or Charlie! -- and compiler settings for it. Obviously the way to go,
but see what I can do in the meantime w/ code I have.

-----------------------------------------------------------------------------

24 April

For the moment, try to handle the only compile error on G5. Start with a different 2008
copy of code, Ngale19Oct2008: it has changes to 34 files in both, plus 4 new files,
incl. EndianUtils.h. Most of its differing files are dated May 2008, a few (e.g.
CoreMidiUtils.cp) August 2008. Code changes include what looks like remembering the
MIDI device setting :-) and adding to QuickChange setting beam thickness & dynamic size.

Clean Nightingale (w/ options), build => nope; now it gets 2 errors in File.cp. ??

-----------------------------------------------------------------------------

25 April

David sez:

> I have lately been compiling ngale with xcode 2.5 on a Macbook Pro running Leopard.
> Ngale runs fine on Snow Leopard, which will only run on intel macs.

Obviously we need to compile with Xcode 3.x soon, so all 149 errors of those need to be
dealt with, but we can get off the ground first! Concern about the Architecture option is
premature; generating PPC code is fine for now.

Back to compiling on my G5.
Have 2 compilation errors in File.cp: lines 136 & 1127. Both involve calls to
fix_end(param); one or both error messages (I can't tell!) are " 'fix_end' was not
declared in this scope".  In EndianUtils.h (NB by Michel) are two #defines for
fix_end(v), and numerous other calls to fix_end in File.cp are OK. What's wrong with
these??

Uh-oh: it looks like it stopped _trying_ to compile w/ File.cp (unlike Xcode 3.2 on my
MacBook)! Yep: there's a Preference "Continue building after errors", and it's not
checked, so maybe a lot more errors to be found  @#%&(#)%$$#% .  Check that Preference,
Build (132 files to go)...

Let's redo the whole thing. Quit & relaunch Xcode; Clean (w/ both options checked); 
compiling 175 files => "Build failed (6 errors, 8278 warnings)"

The errors are all " 'fix_end' was not declared in this scope":
1 in File.cp
3 in HeapFileIO.cp
1 in StringPool.cp

??

The Xcode C compiler is gcc. I still don't see any way to set compiler options (to make
it less picky, etc.) in Xcode, either 2.5 or 3.2; maybe directly via settings of gcc's,
maybe in a dot file it looks at -- should say in the GCC manual, at least! But CER should
know.

-----------------------------------------------------------------------------

Install Git & GitHub on G5... Following the instructions at http://help.github.com/mac-set-up-git/ :

First: Download and Install Git.
Git Installer 1.6.5 - OS X - Leopard - Universal Binary appears to be the most recent version
that runs on a PPC. On my G5, download it (checksum de241004d35a9ef96e1339b78107d12b1c1fbd79).
Unpack & run it => claims to have worked OK.

(NB: At Michel S.' behest, I installed Git 1.5.x on one of my computers in Feb. 2008 --
probably the G5: on it, /opt/local/bin contains ca. 140 files of form "git*, all created
on 15 Feb. 2008 :) , while on the MacBook, there's not even a /opt directory. BUT most or
all of those files are binaries of utilities, and most or all are Intel, not PowerPC! ??
Cf. NgalePort_Feb2008.txt)

Next: Set Up SSH Keys.
1. Check for SSH keys. I have some, but only in file known_hosts; I don't have any id_rsa*
	files.
2. Backup and remove existing SSH keys. ??They only want you to do this for id_rsa* files,
	so it seems I don't have anything to do here.
3. Generate a new SSH key. ??I can't do it: 
	DonDualG5:.ssh donbyrd$ ssh-keygen -t rsa -C "donbyrd@indiana.edu"
	-bash: /opt/local/bin/ssh-keygen: Bad CPU type in executable

I suspect I could find ssh-keygen for PPC on the Web, but is that really what I should do?

etc. etc...  I give up.

Install Git & GitHub on MacBook: all OK!

-----------------------------------------------------------------------------

- (NDAB, "") Respacing bug: in some situations, Respace leaves way too much space after
a dotted note/chord. E.g., w/ long note on downbeat on one voice on a staff, adding
note/rest to a 2nd voice on a staff, maybe as if the new note/rest follows the long note
(I think). E.g., open respaceBug_5LTC.ngl; in m. 2, insert note in voice 2 on bottom
staff => adds lots of space before it. ?? I can't reproduce this starting w/ New score.
But compare FanfareRESPACE_BUG.ngl (dotted chords get way too much space) to the very
similar FanfareRESPACE_NOBUG.ngl (dotted chords get a reasonable amount of space)! Could
it somehow just be caused by the magnified view? No.

(18 June)

Cf. FanfareRespaceBug.ngl (has the bug) to the apparently-identical FRBNew_NoBug.ngl (no bug)!
It looks like it's an issue for _old files_ only. ?!?

(26 March 2013)

SpaceHighLevel.c looks like where this is happening. If I #define SPACEBUG, then hold down
shift & option while respacing, routines there (ConsidIPWidths, ConsiderWidths, Respace1Bar,
etc.) will show copious debug info!

(1 April 2013)

The difference between the newly-simplified FanfareRESPACE_BUG.ngl and FanfareRESPACE_NOBUG.ngl
is obvious: the former has Graphics (strings) and dynamics, and the latter doesn't -- BUT the
difference between the _really_ simple FanfareRespaceBug.ngl & FRBNew_NoBug.ngl isn't at all
obvious: neither has Graphics or dynamics. Each consists of the same 3 notes (dotted qtr,
dotted qtr, qtr; none have accidentals) barline. ?? @#$%#$%$()_%#%

Open FanfareRespaceBug; Respace m. 1 at 44%:
(see RespaceBug.txt for lotsa details)

(4 April 2013)

Sigh. The bug resulted from my kludge to test notehead graphs, invoked when Show Duration
Problems was selected! Oh well. Fixed, and notehead-graphs code cleaned up.

-----------------------------------------------------------------------------

- (New in "", BUT an early OS X version had a _very_ similar problem!) Launch built
Ngale on MacBook => computer seems to be hung for a very long time -- several minutes;
then all is fine! Launching Rosetta alone couldn't possibly make things _that_ bad, but
could it be partly due to launching Rosetta? Even that seems unlikely, since I
literally haven't seen it in years; for info about earlier problems of this kind, see
comment of Dec. 2007 in NgaleXUserProblems+Annoyances2008.txt, of July 2008 in
Ngale_XcodeProblems.txt.

Test on my MacBook, 6 May: Launch at 9:18:00; menubar clock stopped (with arrow cursor)
at 9:18:17; at (actual) 9:21:40, beachball appeared, disappeared, reappeared several
times;  at 9:24:10, _started_ to get back to normal (menubar clock updated erratically,
could switch apps); at 9:27, dot appeared in dock next to Ngale icon & could see palette
frame); at 9:28, could open New score. On my G5: Ngale launches & is ready to use instantly.

Re-test on MacBook: Launch at 14:29:00; splash screen appears at ca. 14:32:50; dot in
dock at 14:33:40; at 14:35, ??  Well, it's not at all clear this is worthwhile,
debugging problems with a PPC build on an Intel machine, when we pretty much want to
forget the PPC anyway -- but PPC is the only choice for Active Architecture in Xcode 3.2
on my MacBook. ?!?

-----------------------------------------------------------------------------

9 May 2012

Set SDK to 10.5, Clean, build => OK, w/ 7152 warnings. Launch at 20:33:25 => computer
seems hung w/ menubar clock frozen; splash screen appears at 20:35:20, disappears again;
palette appears at 20:36:25; at 20:37:xx, can try to use the Open command -- but it takes
a couple of min. to open a tiny score. ?!?

-----------------------------------------------------------------------------

Date:  	Sat, 12 May 2012 23:20:38 -0400 [05/12/2012 11:20:38 PM EDT]
To:  	charles.e.rose@comcast.net...
Subject:  	Re: [launching Ngale freezes the computer]

I just tested this after rebooting, and Ngale launched in a reasonable amount of time. I
don't know why it's so bad under other circumstances, but it looks like this is probably
not a serious problem after all!... 

-----------------------------------------------------------------------------

15 May

Date:  	Tue, 15 May 2012 11:24:34 -0400 [11:24:34 AM EDT]
From:  	"Byrd, Donald A." <donbyrd@indiana.edu>
To:  	Geoff Chirgwin <geoff@chirgwin.com>
Cc:  	"Gottlieb, David" <ngale109@comcast.net>
Subject:  	Re: [Have] Xcode 4.x for Snow Leopard, but...

Downloaded and installed... However, when I open the project, it says "1 target, missing
base SDK" (of course it was pointing to the 10.4 SDK), then says it has no files. Well,
I assumed the project would be in the GitHub repository, so I threw away the project
file. Then -- in Terminal -- I went to my root directory, Nightingale, and did "git
pull"; that deleted 12 files, I think the ones you removed last week, but didn't give me
a project file. Next, I'd kept 3.2.6 around by moving it from Developer > Applications
to Developer > Xcode3p2p6, so it seems I ought to be able to use that to change the base
SDK, but 3.2.6 wouldn't run from that location and I'd rather not screw around any more.
Can you send me a 4.2-compatible project? Or, shouldn't it be in the repository? Put it
there and I'll git it.

-----------------------------------------------------------------------------

22 May

Set up Xcode ala RestorePPC+10p4+p5_SDKSupport2Xcode4.html, so 4.2 supports targeting OS 10.4
& 10.5, GCC 4.0, etc.:

+ Uninstall Xcode
+ Step 1: Install Xcode 3.2 in new top-level directory Xcode3
+ Step 2: Install Xcode 4.2 in default location
+ Step 3: Restoring 10.4/10.5 SDK Support
- Step 4: Restoring GCC 4.0 Support
	?? "cd: /Developer/usr/libexec/gcc/powerpc-apple-darwin10: No such file or directory". ??
- Step 5: Restoring PPC Support for GCC 4.2

-----------------------------------------------------------------------------

Early June

Nightingale_Prefix.pch currently #define's: TARGET_API_MAC_CARBON,
	TARGET_API_MAC_CARBON_FILEIO, TARGET_API_MAC_CARBON_MIDI, TARGET_API_MAC_CARBON_MACHO ?? .
	For the time being, assume they're always #define'd.
USE_GRAFPORT, USE_PROFILER, COPY_PROTECT, LIGHT_VERSION are currently _not_ #define'd; for
	now, assume they're never #define'd.

Code review status:
* Done with all thru the last of 30 May. (Assume "Merge branch 'RemoveMidiCruft'" is okay
w/o reviewing.)
* Done with 7 June
* Done with 10 June

-----------------------------------------------------------------------------

March-April 2013

NB: Unless otherwise mentioned, all development below was done with Xcode 2.5 on my G5,
running OS 10.5.8.

Running Ngale inside Xcode, I can again see (and copy/save) DebugPrintf output
via Xcode's Run Log! Hooray!

+ Change max. tempo from 600 to 1200 BPM. Affects defs.h

+ Print status of reading Prefs file, checking CNFG, etc. Affects Initialize.cp

+ Advance expiration date by a year. Affects InitNightingale.cp

+ Don't print info on every Sync as it's played. Affects MIDIPlay.cp

+ Display values of all CNFG fields in log; if any are bad, list all bad ones in error message.
Affects Initialize.cp

+ Fix "Respace sometimes leaves way too much space, especially after a dotted
note/chord" bug. Affects vars.h; DrawNRGR.c, InitNightingale.c, SpaceTime.c: add global
<doNoteheadGraphs> to say whether to display noteheads as tiny graphs; defs.h:
declaration of <NOTEHEAD_GRAPH_WIDTH>.

+ Minor cleanup. Affects SpaceHighLevel.c

-----------------------------------------------------------------------------

20 April - 13 Aug.

+ (G5B) Ledger lines (both above & below staff) are always the length for chords
w/ 2nds, i.e., they go much too far on the "wrong" side of the stem if there aren't
2nds. I don't think I'd seen this bug until the last month or two, i.e., it's not in
NightingaleDAB or the "official" versions, but only in versions built recently on my G5.
The CNFG ledgerLLen value is 48; could that be the cause? No: ledgerLOtherLen controls
this. Besides, 48 isn't just a legal value, it's the value Ngale sets to replace illegal
values -- e.g., the value of 20 in the default Nightingale Devel Prefs! 32 is the min.
legal value; it's in 32nds of space between staff lines, so 48 = 1+1/2 spaces is about
what it _should_ be. ??

!! ledgerLOtherLen = 48, the same as ledgerLLen: that's almost certainly the problem! --
in fact, 20 might be about right for this. What has it always been?? It looks about 1/2
space => ledgerLOtherLen = 16 -- or maybe 20 :-) . RESOLUTION: This is caused by the
default Devel Prefs (in ~/Library/Preferences/Nightingale\ Devel\ Prefs), which has
ledgerLLen = 20 and ledgerLOtherLen = 48; it should be the other way around. It also has
illegal values for whichMIDI (=4) and courtesyAccSize (=8). NEED TO FIX. Specifically
("In rsrc" = Nightingale.rsrc of e.g. 30 Apr. 2012):

ofst	Item		Now	In		Should
						rsrc	be
---------------------------------------------
??	ledgerLLen		20	48		48
??	ledgerLOtherLen	48	12		20
??	whichMIDI		4	??		0 -- MIDISYS_NONE; prob. want 1 ??IS THIS MIDISYS OR MIDIDR?
??	courtesyAccSize	8	??		>=20; prob. want 100	??Rezilla doesn't seem to list!

Ah-hah! Resorcerer shows a field at offset 173, just after octaveNumSize, as "Open
NoteScan File tolerance for combining subobjects"; it's followed by lineLW. But Ngale's
config struct has nothing about NoteScan tolerance -- it goes directly from octaveNumSize
to lineLW. Result: every field after that is off by one byte!!

-----------------------------------------------------------------------------

Early Aug.

??For CNFG #128, Rezilla shows about 159 fields; Initialize.cp checks only 100, and
comments claim there are only a few uncheckable ones! What about the other 50+ fields?
They include:
	slashGraceStems
	bracketsForBraces
	paperRect
	toolsPosition
	origin
	powerUser
	dblBarsBarlines
	disableUndo, assumeTie, delRedundantAccs, strictContin, turnPagesInPlay
	earlyMusic
	chordSymDrawPar, endingHeight, drawStemlets, noTripletBias
	ignoreRecVel
	tempoMarkHGap
	trebleVOffset, cClefVOffset, bassVOffset
	...and lots more
	
Many of these, probably most, could be checked -- and ALL of their values could be
displayed, of course.

-----------------------------------------------------------------------------

8-10 June

- Both Sonata and BlueNotz on both my MacBook and G5 fail to display the "ff" dynamic on
screen; change the font or double-click the "ff" and change to another dynamic => it
appears. Exception: "ff" _is_ visible with Sonata in some very small displayed sizes,
e.g., staff size 5 at magnifications 38% & 50% only! (It's never visible with BlueNotz,
as far as I can see.) In every other respect including PostScript printing, "ff" behaves
fine! It's no problem in Briard. All other dynamics display OK in all
fonts/sizes/magnifications. David G. sez: "It works as it should in v.5.2.6, i.e. pre
5.3.x. I went as far  back in 5.3 as 5.3.0b4 of September 2008, and the bug was there."
So, what changed between 5.2.6 and 5.3? If the complete source code for both is available
this might not be hard to fix!

Non-hairpin dynamics are drawn in DrawObject.c/DrawDYNAMIC; it has helper function
DrawUtils.c/GetDynamicDrawInfo.

Add to DrawDYNAMIC		DebugPrintf("DrawDYNAMIC: glyph=%c\n", glyph);
Invisible_ff_bug.ngl contains:
	LINK	CHARCODE	WHAT
	10		112			"p" attached to...
	11		207			quarter note
	12		196			"ff" attached to...
	13		207			quarter note

in staff size 1, using Sonata. Open it and draw several times at diferent sizes/magnifs. =>

	DrawDYNAMIC: glyph=p
	DrawDYNAMIC: glyph=\304\304DrawDYNAMIC: glyph=p
	DrawDYNAMIC: glyph=\304\304DrawDYNAMIC: glyph=p
	DrawDYNAMIC: glyph=\304\304DrawDYNAMIC: glyph=p
	DrawDYNAMIC: glyph=\304\304DrawDYNAMIC: glyph=p
	DrawDYNAMIC: glyph=\304\304DrawDYNAMIC: glyph=p
	DrawDYNAMIC: glyph=\304\304DrawDYNAMIC: glyph=p
	DrawDYNAMIC: glyph=\304\304DrawDYNAMIC: glyph=p
	DrawDYNAMIC: glyph=\304\304DrawDYNAMIC: glyph=p
	DrawDYNAMIC: glyph=\304\304DrawDYNAMIC: glyph=p
	DrawDYNAMIC: glyph=\304\304DrawDYNAMIC: glyph=p
	DrawDYNAMIC: glyph=\304\304DrawDYNAMIC: glyph=p
	DrawDYNAMIC: glyph=\304\304DrawDYNAMIC: glyph=p
	DrawDYNAMIC: glyph=\304\304DrawDYNAMIC: glyph=p
	DrawDYNAMIC: glyph=\304\304DrawDYNAMIC: glyph=p
	DrawDYNAMIC: glyph=\304\304DrawDYNAMIC: glyph=p
	DrawDYNAMIC: glyph=\304\304DrawDYNAMIC: glyph=p
	DrawDYNAMIC: glyph=

Why is \304 repeated and w/o newline? I dunno. Anyway,
Change to		DebugPrintf("DrawDYNAMIC: glyph=%c pL=%d\n", glyph, pL);
output for Invisible_ff_bug.ngl now, drawing it twice:

	DrawDYNAMIC: glyph=p pL=10
	DrawDYNAMIC: glyph=\304 pL=12
	DrawDYNAMIC: glyph=p pL=10
	DrawDYNAMIC: glyph=\304 pL=12
	
Output for DynamVisibleTest.ngl is:
	DrawDYNAMIC: glyph=\354 pL=11
	DrawDYNAMIC: glyph=\304 pL=13
	DrawDYNAMIC: glyph=f pL=15
	DrawDYNAMIC: glyph=F pL=17
	DrawDYNAMIC: glyph=\270 pL=20
	DrawDYNAMIC: glyph=\271 pL=22
	DrawDYNAMIC: glyph=p pL=24
	DrawDYNAMIC: glyph=P pL=26
	DrawDYNAMIC: glyph=S pL=29

Add more to the DebugPrintf. Output for Invisible_ff_bug.ngl at 100%:
	DrawDYNAMIC: glyph=p pL=10 xp=153 yp=114 size=24 reallyDraw=1
	DrawDYNAMIC: glyph=\304 pL=12 xp=182 yp=115 size=24 reallyDraw=1

...at 75%:
	DrawDYNAMIC: glyph=p pL=10 xp=115 yp=85 size=16 reallyDraw=1
	DrawDYNAMIC: glyph=\304 pL=12 xp=136 yp=87 size=16 reallyDraw=1

...at 50%:
	DrawDYNAMIC: glyph=p pL=10 xp=77 yp=57 size=12 reallyDraw=1
	DrawDYNAMIC: glyph=\304 pL=12 xp=91 yp=58 size=12 reallyDraw=1

Nothing suspicious there! Change to staff size 5, still at 50%:
	DrawDYNAMIC: glyph=p pL=10 xp=69 yp=44 size=7 reallyDraw=1
	DrawDYNAMIC: glyph=\304 pL=12 xp=78 yp=44 size=7 reallyDraw=1

Still nothing suspicious (and ff is now visible, as expected). Revert file; switch font
to Briard, at 100% =>
	DrawDYNAMIC: glyph=p pL=10 xp=153 yp=114 size=24 reallyDraw=1
	DrawDYNAMIC: glyph=\304 pL=12 xp=182 yp=115 size=24 reallyDraw=1

Exactly the same as with Sonata (and ff is now visible, as expected). @#%&(*)$%${?!?

DrawDYNAMIC uses DrawUtils/DrawMChar to actually draw the char.  DrawMChar is pretty
messy, e.g., it sometimes uses an offscreen bitmap, so it's not hard to believe it's the
culprit... But apparently not. ????

The inconsistency across staff sizes is most likely because the problem occurs
with some screen font sizes and not others -- assuming "screen fonts" are still being
used!


-------------------------------------------------------------------------------

3 July

- Files often seem to forget their MIDI playback setting, so when I try to play, it
either gives the "unable to play score, because a MIDI device isn't selected" error
message, or (much more often) acts as if it's playing for a split second but plays
nothing. Setting DLS_MIDI Controller for all parts fixes; but saving and re-opening
the file after that changes nothing. This is a well-known, long-standing bug. I
think it happens much more (or only?) with files created years ago, regardless of
how much they've been edited recently.

First, what does setting DLS_MIDI Controller actually do? The "Part MIDI Settings"
dialog is handled by Menu.c/EditPartMIDI, which calls InstrDialog>PartMIDIDialog or
CMPartMIDIDialog (which does almost nothing but call PartMIDIDialog).

Playing is handled by MIDIPlay.c/PlaySequence

-------------------------------------------------------------------------------

9 Aug. ff.

It's time to add to QuickChange "Set tempo M.M. visibility to visible/invisible"!
...Done. Affects .rsrc: add "M.M. visibility" to Tempo popup; SetUtils.c: add
SetSelTempoVisible; SetCommand.c: improve description of how to add features :- ) ;
various.

-------------------------------------------------------------------------------

29 Aug.

Want to make windows for newly-opened files wider: at least full page width instead
of the current annoying width of ca. 560 pixels -- at 100% for US Letter pages,
about 9/10 the width! Where is this set? Doesn't seem to be in the config.

OpenFile() is called only from BuildDocument (in Documents.cp).  BuildDocument()
declares

	WindowPtr w = doc->theWindow

and does

	GetWindowPortBounds(w,&r);

BuildDocument is called from DoOpenDocument (in Documents.cp). ??

(21 July 2015

Got it! In WIND resource 2000, just change right bound from 620 to 690.)
 
-------------------------------------------------------------------------------

1-2 Nov. 2014; 11 Aug.- 15 Sept. 2015

Tempo changes in exported MIDI files are often ignored -- e.g., 6End1stMvmt.ngl of my
violin concerto has 13 tempo marks. The first 6 or so seem to be there; the others,
starting at m. 5-6 (ca. 10-12 sec. in) not. In 1LentoTheme, they're OK until about m.
101 (4 min. in), i.e., the first 5 or so! Playing inside Ngale, all tempo changes are
always followed. ?? Evidence of the bug: playback via QuickTime Player; confirmed by
Importing the MIDI file back into Ngale. Output from DebugPrintf's for 6End1stMvmt.ngl
starts:

MThd len=6 format=1 nTracks=5 timeBase=480
lastEvent=50353
mergeTabSize=32767 oneTrackTabSize=32767
 track=1 time=0 METAEVENT type=0x51
 track=1 time=0 METAEVENT type=0x58
 track=1 time=1914 METAEVENT type=0x51
 track=1 time=5754 METAEVENT type=0x51
 track=1 time=6714 METAEVENT type=0x51
 track=1 time=7674 METAEVENT type=0x51
 track=1 time=12432 METAEVENT type=0x51
 track=1 time=12432 METAEVENT type=0x51
 track=1 time=15360 METAEVENT type=0x58
 track=1 time=16800 METAEVENT type=0x58
 track=1 time=33137 METAEVENT type=0x3
cStart/StopTime=0/50400 quantum=120 tripBias=-100 tryLev=21 leastSq=0 timeOff=0

There are 7 tempo metaevents (type=0x51). The first 5 are each at 6 less than the
expected times; the 6th and 7th are at the identical time, much too late. Cause: In
MIDIFSave.cp, WriteTiming() gives a Tempo change the latest end time of any note
preceding the one the Tempo is attached to (via LastEndTime() ); in this case, a
preceding note is tied forward for a couple of measures! What to do? Why did we ever
write the code this way instead of just using the onset time of the note the Tempo is
attached to?? NB that playback inside Ngale seems to work perfectly!; how about making
Export MIDI File do things the same way? Cf. MIDIPlay.cp > PlaySequence(). It uses a
table built by MIDIUtils.cp: MakeTConvertTable(); try using that in Export MIDI File?
Probably not, but use its logic for finding the Tempo's time => seems to still have
problems. Output from DebugPrintf's for importing the MIDI file of 6End1stMvmt.ngl now
starts:

MThd len=6 format=1 nTracks=5 timeBase=480 (qtrNTicks=480)
lastEvent=50353
mergeTabSize=32767 oneTrackTabSize=32767
 track=1 time=0 METAEVENT type=0x51 (TEMPO)
 track=1 time=0 METAEVENT type=0x58
 track=1 time=1920 METAEVENT type=0x51 (TEMPO)
 track=1 time=5760 METAEVENT type=0x51 (TEMPO)
 track=1 time=6720 METAEVENT type=0x51 (TEMPO)
 track=1 time=7680 METAEVENT type=0x51 (TEMPO)
 track=1 time=8640 METAEVENT type=0x51 (TEMPO)
 track=1 time=9600 METAEVENT type=0x51 (TEMPO)
 track=1 time=15360 METAEVENT type=0x58
 track=1 time=16800 METAEVENT type=0x58
 track=1 time=16800 METAEVENT type=0x51 (TEMPO)
 track=1 time=19200 METAEVENT type=0x58
 track=1 time=21120 METAEVENT type=0x58
 track=1 time=23520 METAEVENT type=0x58
 track=1 time=26400 METAEVENT type=0x58
 track=1 time=27360 METAEVENT type=0x51 (TEMPO)
 track=1 time=28800 METAEVENT type=0x51 (TEMPO)
 track=1 time=30240 METAEVENT type=0x51 (TEMPO)
 track=1 time=30720 METAEVENT type=0x51 (TEMPO)
 track=1 time=31200 METAEVENT type=0x51 (TEMPO)
 track=1 time=31200 METAEVENT type=0x58
 track=1 time=50352 METAEVENT type=0x2f
cStart/StopTime=0/50400 quantum=120 tripBias=-100 tryLev=21 leastSq=0 timeOff=0

This shows all 13 tempo metaevents, and the times are all correct! Play the MIDI file
back via QuickTime => it sounds correct; duration = 54.58 sec. Play the original back in
Ngale => duration = ca. 54.45 sec. Looks like MIDI file export finally handles tempo
changes properly!

-------------------------------

Early code changes for the above:
MIDIPlay.cp: reword DebugPrintfs; disable some
MIDIFSave.cp: WriteTiming(): add DebugPrintf
MIDIFOpen.cp: comment out PUBLIC_VERSION_1 to enable debug prints; do debug prints
if shift & control keys are down instead of shift & option (to make it possible to
get debug prints from this module but avoid the voluminous output from rhythm
conversion)

-------------------------------------------------------------------------------

23 Mar. 2015

Get rid of the nonsensical statement about duration problems Score Info always gives
following its correct statement about duration problems.

ScoreInfo.c: ScoreInfo(): remove two redundant lines of code just before call to
HasMidiMap().

-------------------------------------------------------------------------------

31 Mar.-3 Apr.

Changes to Nightingale.rsrc:
*	Change "Midi" to "MIDI" in the "Midi Map" menu command, the MIDI Map dialog, and
	several error messages
* Reduce size of the "MIDI Modifier Effects" dialog
* Reduce size of the "Change Dynamic To" dialog
* Remove phony politeness -- the word "Please" -- from various dialogs

Increase max. play duration allowed in Set Duration dialog from 300% to 500%, mostly to
handle the "logical 8th note with half-note head" situation (as in Brahms piano music).
Affects .rsrc: STR# 240; DialogsEditor.cp.

-------------------------------------------------------------------------------

4-5 Apr.

Initial Keysigs of systems with no sharps/flats usually (always?) have objRects of (0,
0, 0, 0); that's fine, but Debug Check complains that they're "GARBAGE (UNSELECTABLE)".
Fixed this. Affects DebugUtils.c: DCheckNode.

-------------------------------------------------------------------------------

11-17 May

In various situations -- e.g., to facilitate working on my violin concerto with a
violinist -- it'd be very useful to override tempo marks in the score, say slowing down
by 25% or cutting the tempi in half. To do this, assuming we're changing the marked
tempi by a constant factor, and leaving the user interface out, it looks like the only
code changes it'd take would be to MIDIUtils.cp/PDur2RealTime(). It looks very low
impact, too!

Done => it works! But the factor is compiled in to MIDIUtils.cp; move it to vars.h and
initialize it in InitNightingale: InitNightGlobals => done. To let user control it, need
a new command in Play/Rec menu and either (1) a very simple dialog to set value to be
used by all Play commands, or (2) a fairly simple one to set value _and_ play, with a
choice of play command. I'll go with #1, "Change Playback Speed...", w/ feedback in
message area in form "T80%" (e.g.) if speed isn't 100%. Affects .rsrc: STR# 240;
NightTemplates.h, NResourceID.h, vars.h, InitNightingale, Menu, MIDIDialogs, MIDIPlay.

Everything seems OK now, except the keyboard shortcut for the "Instrument MIDI Settings"
command in the Play/Rec menu (option-cmd-M) has lost its modifier key #(#%_^&!:* -- I'm
almost certain because of a bug/oversight in Resorcerer. General Edit Lite is useless for
anything like this (actually, for almost anything, I think :-( ). For the moment, use
Resorcerer to set the _command_ to option-M! This works fine on my G5 except it displays
in the menu as option- command-mu instead of command-M with the "option" icon. But on my
OS 10.6 MacBook, it doesn't work! I'm sure I've run into this before, & I think I found
an ugly workaround involving copying another menu resource & (hex?) editing it; but how
to do that or otherwise avoid the problem? One difficulty with that workaround:
Resorcerer's hex editor seems to be completely disabled! -- at least for menu resources.

-------------------------------------------------------------------------------

19 May

Change the default type for Save PostScript from EPSF for one page to PostScript
text for entire file. Easy, & obviously very low impact.  Affects CarbonPrinting.cp .

-------------------------------------------------------------------------------

3-10 June

Set keyboard shortcut for Change Playback Speed to command-8. (All letters and all
other digits are already taken.)

Another attempt to set the shortcut for Instrument MIDI Settings to option-command-M
again:
	With Resorcerer, change MDEF for MENU 8 (Play/Rec) from 19999 to 0.
	With Rezilla, change shortcut for MIDI M?? from command-M to option-command-M.
	(M = key 77.)
	With Resorcerer, change MDEF for MENU 8 (Play/Rec) back to 19999.
It works on my G5 inside Xcode; on my G5 as a normal app; and on my OS 10.6 MacBook!

Change "Change Playback Speed" to "Relative Playback Speed".

-------------------------------------------------------------------------------

12-14 June

Work on getting the instrument settings dialog (from Master Page) initialized with the
instrument's current channel and patch number. Code is in InstrDialog.cp > InstrDialog().
Balance velocity _is_ initialized; what's the difference? Ah, there's no PutDlgWord()
to set CHANNEL_DI or PATCH_DI. How could this ever have worked!? Add PutDlgWord()s for
them -> it works now!

Also, PATCH_DI isn't checked for legality -- or its new value picked up => Fixed; a
rough edge is the alert for illegal values is blank. !?  Oh well, good enough for now.

-------------------------------------------------------------------------------

21-24 June

Feature to add: a way to mute a part, to facilitate working w/ a soloist (e.g.,
violinist for my concerto). (Setting balance velocity to -127 already does it, but only
in polyphonic mode; also, it's clumsy & unintuitive.) Simple solution:

(1) add a command to Play/Rec menu to mute the (or the first) selected part, and
unmute previous muted part; also need a way to unmute all.

(2a) Store part no. of muted part in (a) an initialized but unused byte in a
score-wide data structure, or (b) a global variable.

(3) Of course have MIDIPlay() ignore notes in muted part. What about exporting MIDI files?

For step 2, implementing 2b would be simpler than 2a, but would mean switching from one
score to another would apply the muted part no. of the first score to the other; that's
likely to be very confusing! So go with 2a.  Should it be saved with the score? Unclear.
It might be ??

In NIGHTSCOREHEADER (Ntypes.h), is expansion[] initialized? Looks like not! How
about roomToGrow[] to MIDIPreferences (applicationTypes.h)?

-------------------------------------------------------------------------------

22 July

The default window size is ridiculously narrow on a typical modern display, e.g., my
20-in. monitor. Fix: in the resource WIND 2000, just change 620 to, say, 690. NB:
Resorcerer on my G5 shows an empty window for the content of WIND 2000!?  Make the
change on my old MacBook  => it works.

-------------------------------------------------------------------------------

9-10 Sept.

I'm getting an awful lot of meaningless complaints from Debug these days, e.g., with the
current LentoThemeCounterpoint.ngl:

	DCheckNode: MEASURE AT 1088 BBOX DISAGREES WITH NEXT MEASURE BY 567.
	DCheckNode: MEASURE AT 1109 HAS A GARBAGE BBOX.
	DCheckNode: MEASURE AT 1109 BBOX DISAGREES WITH PREVIOUS MEASURE BY -567.

...always in sets of three as above. And with the current TransitionTo+BACH+End.ngl:

	*DCheckNode: SYSTEM AT 68 RECT PAST RIGHT MARGIN.

Could the changes to DebugUtils.c: DCheckNode of 5 April to reduce meaningless
complaints have actually made things worse? Compare old to current version of DebugUtils
on LentoThemeCounterpoint.ngl & TransitionTo+BACH+End.ngl => nope; in both, the newer
version of DebugUtils eliminated some complaints without adding any new ones.

The "SYSTEM AT 68 RECT PAST RIGHT MARGIN" messages for TransitionTo+BACH+End.ngl never
apply to the 1st system of a page... ??  Go into Master Page; decrease right margin a bit;
save changes; back into Master Page; set right margin back to what it was => no more
complaints! This is probably a good enough workaround :-| .

For the "MEASURE BBOX" messages for LentoThemeCounterpoint.ngl, Go into Master Page;
decrease right margin a bit; save changes => no more complaints! This is also probably
a good enough workaround.

-------------------------------------------------------------------------------

12-16 Sept.

MIDIFSave.cp: Clarify DebugPrintf's; minor cleanup.

MIDIPlay.cp, MIDIFSave.cp: Change most instances of "Midi" in function names to "MIDI".

MIDIFOpen.cp: In Debug prints for TEMPO metaevents, add "(TEMPO)"; rename the two
versions of GetRelObj (with different calling sequences: this assumes a C++ compiler,
a bad idea in a program that's virtually all straight C) to GetTempoRelObj and
GetCtrlRelObj; clean up code.

-------------------------------------------------------------------------------

17-30 Sept.

Text strings need an "extended" option. Easy UI implementation: in the text dialog,
replace the hidden "Underline" check box and code to support it with "Extended", and
make it visible. Easy functionality implementation: before drawing the string or
computing its length, insert a blank between each pair of chars. :-) . This isn't _that_
easy, partly because of our memory mgmt., partly becauase we have to give the ancient
Mac toolbox Pascal strings, which have a max. length of 255 chars.; probably warn in the
dialog if it's exceeded.

In DrawObject.cp > DrawGRAPHIC(), see case GRString. Probably need to use Pstrcpy()
to make a copy of *q to manipulate, i.e.: Str255 tempStr; Pstrcpy(q, tempStr);

?? #ifdef TARGET_API_MAC_CARBON, DrawNChar() and DrawNString() seem to always use the
system font! Huh? And it _is_ defined -- but DrawNChar() and DrawNString() are never
called. It was already this way in 2006. Yeeech! Remove this junk... done.

Add function ExtendString() => 1st 10 versions crash instantly & horribly; why? It
looks like doing _anything_ with aGraphic->string directly is a disaster; _must_
use PCopy() on it.

To compute objRect, cf. GetNPtStringBBox(), called from GetGraphicDBox()... the
functionality works both on screen and PostScript output!

The UI changes now work in both TextDialog and the Define Text Styles dialog. But normal
extended text is only a bit (25%?) wider than normal, but want to stretch a lot more
than that! Let's call this "Expand" instead of "Extend". Must check for strings too
long for Expand'ing (because of the Pascal string 255-char. limitation :-( )

All seems to be okay! Affects .rsrc; defs.h; DrawObject, StringUtils, TextDialog.

-------------------------------------------------------------------------------

I'm now seeing consistent failures just trying to compress NightingaleG5Ver! I get the
error message "An error occurred while adding “” [empty filename] to the archive".
Experiments show the problem is in build/Nightingale.build/Release. Remove that
directory, rebuild => all OK.

-------------------------------------------------------------------------------

2 Oct. - 3 Oct.

I'm _finally_ ready to use a version control system for Ngale!! A GitHub repository
already has the last "AMNS" codebase (from David Gottlieb, ca. 2012) with voluminous
changes, mostly superficial and mostly by Geoff C. The vast majority of the changes
appear to be replacing thousands of occurrences of "INT16" to "short"; to facilitate
merging, change all instances of "INT16" in files I've changed since 2013 to "short".

CarbonPrinting.cp: Geoff made loads of changes; I changed only one char., so use his
version with my change.

DrawUtils.cp: I'd made no non-trivial changes.

OK, everything is integrated! Try to build => 9 errors. Looks like #defines are
missing for NOTEHEAD_GRAPH_WIDTH and EXPAND_WIDER .

Both should be in defs.h; why aren't they? Because I overlooked defs.h when integrating
all the changes. Correct that, rebuild => 1 error: OhioSlurs.cp is missing -- the ref.
to it needs to be removed from the project file. Do that => it builds & runs!! Yippee!

Call this version 5.5.

-------------------------------------------------------------------------------

27 Sept. - 12 Oct.

Implement muting a part: at most one part at a time, per Document; not saved bcs when a
file is opened, no part should ever be muted. To keep track, add a field (MAXSTAVES =
64, so max. no. of parts = 64, so >=6 bits) _mutedPartNum_ to the Document declaration
in applicationTypes.h ; 0 = no part, else the no. of the muted part. Add it where? The
comments say fields both at the beginning and the end don't need to be saved; the end
seems safer :-) . Test by opening a couple of good-size scores => seems OK! Initialize
it where? Probably Documents.cp > InitDocFields().

Write functions AnyNoteToPlay() and NoteToBePlayed(), to be called from MIDIPlay >
PlaySequence() and MIDIFSave > WriteMFNotes().

Add to .rsrc a "Mute Part" dialog, and add menu item "Mute Part..." to the Play/Rec
menu; add a name for it to NResourceID.h; add code to handle it to Menu.c. Write
handler for the Mute Part dialog => it works! Last details:
+ Put smthg in the "Playing" display to indicate muting. There's very little room,
	so probably just boldface "M"
+ For Save MIDI File, could ask user if they want to omit the muted part, but it's
	easier to always omit it (and warn user it'll be omitted). (If the muted part is
	the only part, don't bother saving the file.)
+ If no file is open, need to disable Mute Part and Relative Playback Speed cmds!

Clean up code a bit: remove last VIEWER_VERSION code; update comments in compilerFlags.h.

-------------------------------------------------------------------------------

13-14 Oct.

With two voices on a staff, Ngale computes space needed based on the merged voices
even if one is so far above the other that they don't interact, resulting in it
sometimes allocating way too much space for a Sync. Cf. violin concerto, II,
3VCBVariation, m. 9. A solution: add a flag to the ANote struct that says "when
respacing, ignore this note", or, better, "ignore the chord this note belongs to"; add
it to the note Get Info dialog.  Est. fix impact: low: there's a byte available to put
this flag in, and it looks like it's been initialized to 0 for many years. ??The byte is
fillerN. Could also take the top bit of ndots:4 -- supporting up to 7 aug. dots is
probably enough :-) . 

Code changes would be in SpaceTime.cp > SymWidthLeft(). However, that function calls
ChordNoteToLeft() with staff nos., while ChordNoteToLeft() expects voice nos.! This is a
mess; it may not be low-impact after all, and may not be worth the effort :-( .

In code to display CNFG fields: add _musicFontID_; rearrange to come closer to the order
of declarations in applicationTypes.h; minor cleanup.

-------------------------------------------------------------------------------

18-28 Oct.

Minor changes to Initialize, DebugUtils.

.rsrc: tweak the Sync Info and General Info dialogs (DLOGs 596 & 598) for readability.

Make the "extended" option for text strings an option independent of the style instead
of part of the style definition. So a flag needs to be stored in the GRAPHIC struct;
the _info2_ field looks like a good place, not used for GRStrings. Is it always
initialized? It looks like it: cf. InitGraphic().

It works! Do the same for tempo marks => that works!

-------------------------------------------------------------------------------

3-10 Nov.

Resume work on "ignore the chord this note belongs to" feature (cf. 13-14 Oct.).
Change SymWidthLeft() to properly use voice nos. in calls to ChordNoteToLeft() (gasp).
Add <noAutospace> flag to the ANOTE struct; in SymWidthLeft(), if main note has
<noAutospace>, ignore the note's chord.; in BrowseSync(), display <noAutospace>.
??

Test:
	SymWidthLeftTest.ngl: m.1, OK; m.2 both tests OK.
	Spacing2VPerStaff2.ngl: m.1, to left OK, to right not; m.2, neither is OK.

Part of the problem is we need more context in SymWidthLeft(), and, no doubt,
SymWidthRight(). But the code is just too messy as it is! Let's precompute an
<ignoreChord> matrix in SpaceHighLevel... done. But now Ngale crashes if I simply
open a test file and try to respace one measure #%^&#)%#)% . Let's go back to the
last known good version, the code in the Ngale 5.5 of 28 Oct. => yep, that still
works :-) . Move towards the latest version. !! When I call SymWidthLeft() with
measNode = -1, i.e., no <ignoreChord> info available, no problem. But when I call
it with the correct values but setting measNode = -99 as the 1st stmt in
SymWidthLeft(), it crashes :-( . In this excerpt from ConsidITWidths():

			/*
			 * We need more space here. Move this object to the right, and
			 * increase the space available on all staves by the same amount.
			 */
**0 DebugPrintf("(Q) i=%d stf=%d gNeedLeft=%d needLeft=%d\n", i, s, gNeedLeft, needLeft);
**1			fSpBefore[i] += fSpNeeded;
			for (t = 1;t<=doc->nstaves; t++)
				fAvailSp[t] += fSpNeeded;
		}
		
		/*
		 *	Re-initialize for the next J_IT object on this staff.
		 */
**2		prevNeedRight[s] = SymWidthRight(doc, spaceTimeInfo[i].link, s, FALSE);	/* Incl. stuff fllwng notehead */
		if (prevNeedRight[s]<gNeedRight) prevNeedRight[s] = gNeedRight;

Before adding line **0, it crashes w/ "EXC_BAD_ACCESS" at **1. After adding **0.
it crashes at **2. ?!?

Something very suspicious: The code has many instances of loops like this:

	for (k = 0; k<=nInMeasure; k++)

But that stmt covers nInMeasure+1 values of <k>! Is that correct?? ...Unfortunately,
yes. <nInMeasure> is a misleading name; it's really <nLast>. OK, I give up! -- at
least for the time being.

-------------------------------------------------------------------------------

11-18 Nov.

Various fields in various Info dialogs are too narrow, truncating labels or even values.
Make the fields and, in some cases, the dialogs wider.

-------------------------------------------------------------------------------

18 Nov.

In the current 1stMovement_Part3.ngl, mm. 52-61, adding whole-measure rests to the
solo violin part results in Ngale thinking mm. 57 & 59 are suddenly longer! Weird;
don't think I've seen this before. Starting in m. 57, it's 4/4 => each measure dur.
should be 1920 ticks. Onset times:

m. 57: 111360
m. 58: 114600 => dur. of m. 57 = 3240 = 1320 (5 eighths + 1 16th) too big
m. 59: 116520 => dur. of m. 58 = 1920
m. 60: 119160 => dur. of m. 59 = 2640 = 720 (3 eighths) too big
m. 61: 121080 => dur. of m. 60 = 1920

!! Deleting the whole-measure rests in the offending bars, then re-inserting them,
fixes the problem. Oh well; it's not worth pursuing this now.

-------------------------------------------------------------------------------

26-27 Nov.

- With a score of very many pages, you can't zoom in very far. E.g., with
1stMovement_Part1FS.ngl's 37 pages, 200% is the limit before Ngale complains the score
won't fit at the new magnification. This makes tweaking details very difficult. Changing
to a larger "paper" size via Page Setup seems to do nothing at all. Changing Screen Page
Layout to accomodate more pages works in that it's recorded in the file, but doesn't
stop Ngale from complaining; cf. Sheet>SheetMagnify(). Either or both are probably worth
fixing.

Where do we check for screen layout overflowing? The complaint for score not fitting
at new magnification is
	#define SCREENOVERFLOW_DLOG 806
But where is it referenced?? In Sheet>WarnScreenPagesOverflow(). Anyway, checking is
done in Sheet>ScreenPagesCanOverflow()... which seems to check _separately_ for
<numSheets> exceeding the layout's no. of rows or its no. of columns -- but I nearly
always have no. of rows as 1, so why don't I have problems w/ any score of more than a
page?? W/ my 37-page score, going from 150% to
200% => 	magnify = 2, numSheets = 37, scale = 2.0;
			doc->numRows = 1, maxRows = 66;
			doc->numRCols = 86, maxCols = 86

Trying to go from 300% to 300% =>
		 	magnify = 3, numSheets = 37, scale = 3.0;
			doc->numRows = 1, maxRows = 66??;
			doc->numRCols = 86, maxCols = 86??
		
!! The problem really is exceeding the width or height of the available space, so
just reducing the no. of columns from 86 to, say, 20 should do it... and it does!
It'd be good to clarify the "score won't fit" error message, but maybe not worth the
time now.

-------------------------------------------------------------------------------

28 Nov.

- With reasonable spacing, only about 25 staves fit on a letter-size page even at staff
size 8, so with a largish number -- e.g., 15 in my violin concerto -- you can get only
one system on a page, Trying to change to a larger "paper" size seems to do absolutely
nothing. More precissely, after changing from default (U.S. letter) to U.S. legal, in CarbonPrinting>
NPageSetupDoneProc(), it looks like

	if (!EqualRect(&doc->origPaperRect,&rPaper)) ...

isn't satisfied, i.e., doc->origPaperRect and rPaper are identical. Well, pmRPaper
is still 612 x 792 points, i.e., 9-1/2 x 11 in. ?? Apple's PMGetAdjustedPaperRect()
must be returning pmRPaper unchanged; I dunno what can I do about that.

Changing from portrait to landscape format _does_ ??

-------------------------------------------------------------------------------

29 Nov. - 7 Dec.

DebugPrintf messages seem to go to /dev/null unless we're running inside Xcode, and
chances to run inside Xcode (2.5!) are very likely to gradually fade away. Solution:
DebugPrintf is #define'd simply as printf. It should be trivial to #define it instead as
the BSD function syslog(3) ...though it'd be nicer to continue to have messages go to
Xcode _and_ send 'em to the log.

Solution: call openlog(p1, LOG_PERROR, LOG_USER) before calls to syslog()!

?? Does this work? I saw some Nightingale messages in the system log, but then nothing
seemed to be there! Maybe it's just scrolled out of the viewable area... Where _is_
the system log file? In /var/log . Try again => nope, nothing there!; anyway, what I
see in Console brackets the time the message was issued. Try w/o calling
openlog() => nope. I've been using level LOG_INFO; try w/ a higher level, LOG_ERR =>
it works! So, contrary to documentation, it looks like the default doesn't send
messages of all levels through. Add back call to openlog() => it still works.
Change level filtering via setlogmask() => it _seemed_ to work... but now it's only
accepting levels LOG_NOTICE and above, i.e., not LOG_INFO or LOG_DEBUG. OK, I can
live with that.

Add VLogPrint(), LogPrint(), InitLogPrint() to Utility; call InitLogPrint() from
initialization code; change COMPLAINx macros in DebugUtils.h from using DebugPrintf()
to LogPrint(LOG_NOTICE, ...) => it works! But probably should use priority level
LOG_ERR.

This has all been on my G5 running OS 10.5. Test on my old MacBook running OS 10.6 =>
OK, and even levels LOG_INFO and LOG_DEBUG appear in the log.

OK, but we often call DebugPrintf() with partial lines or occasionally with multiple
lines. Add support for the former only, & rename xxxPrint functions to xxxPrintf =>
?!? hangs/crashes! -- apparently in strlen(). Run log contains:

1------inStr='A simple one-line LogPrintf.' fullLine=1 &inStr=184f78 pch=184f78 len=28
Ngale: A simple one-line LogPrintf.
1------inStr='Another one-line LogPrintf.' fullLine=1 &inStr=184f78 pch=184f78 len=27
Ngale: Another one-line LogPrintf.
1------inStr='This line is ' fullLine=0 &inStr=184f78 pch=184f78 len=13
1------inStr='built from 2 pieces.' fullLine=1 &inStr=184f78 pch=184f78 len=20
Ngale: This line is built from 2 pieces.
1------inStr='This line was ' fullLine=0 &inStr=184f78 pch=184f78 len=14
1------inStr='built from 3' fullLine=0 &inStr=184f78 pch=184f78 len=12
1------inStr='pieces.' fullLine=1 &inStr=184f78 pch=184f78 len=7
Ngale: This line was built from 3pieces.
1------inStr='DEBUG 'M'-Std: ' fullLine=0 &inStr=184f78 pch=184f78 len=15
1------inStr='CHK MAIN:' fullLine=0 &inStr=184f78 pch=184f78 len=9
1------inStr='Discont. sel, 0 objs in range, 0 sel, 10 total.  0 voices.' fullLine=1 &inStr=184f78 pch=184f78 len=58
Ngale: DEBUG 'M'-Std: CHK MAIN:Discont. sel, 0 objs in range, 0 sel, 10 total.  0 voices.
1------inStr='    CHK MASTER: ' fullLine=0 &inStr=184f78 pch=184f78 len=16
1------inStr=' Done.' fullLine=0 &inStr=184f78 pch=184f78 len=6
1------inStr='    CHK CLIP: ' fullLine=0 &inStr=184f78 pch=184f78 len=14
1------inStr=' Done.' fullLine=0 &inStr=184f78 pch=184f78 len=6
 
!! It looks like strlen() and strcat() both crash if src is the null string, at least
on my G5. It's really hard to believe such a horrendous bug exists _and_ I didn't know
about it, but e.g. putting "if (pch!='\0')" in front of
    	strcat(outStr, pch);
definitely seems to make the problem go away.

Replace ca. 300 instances of "" to "LogPrintf(LOG_NOTICE, "... done.

-------------------------------------------------------------------------------

16-17 Dec.

- Explicit courtesy accidentals are unusable: the parens are always way too low on the
page. I was thinking most of the displacement was because they're off by one staff, and
the rest because the tops are where the bottoms should be. But actually it seems to be
just because _courtesyAccYD_ -- read from the Prefs file -- on my G5 & my old MacBook is
way too large: it's 100, but should be more like the config default of 8. But where _is_
the #%&#)%$%=$)# Prefs file, "Nightingale Devel Prefs"?? It doesn't seem to be anywhere
on the startup disk, and I can't tell from the code where we're looking, but we
certainly seem to be finding it!

Try changing the name to, e.g., "Nightingale 5-AMNF Prefs"? That's probably a good
idea anyway.

??UNFINISHED!

-------------------------------------------------------------------------------

17-19 Dec.

- On MIDI playback, if multiple notes are simultaneously playing the same note number on
the same channel but end at different times, Ngale stops playing that note when the
first one ends. It should at least hold it till the last one ends. It might be better to
re-attack the note at a possibly different velocity, but that'd be more complicated and
it's not clear it'd actually sound better.

This is handled by an eventList; PlaySequence() calls EndNoteLater() which calls
InsertEvent(). So should just check before calling EndNoteLater() (or in EndNoteLater()?),
and if there's already an event w/ that note no. and channel w/ a later ending time,
ignore the Note Off.

Cf. MIDIUtils.cp/InsertEvent(), and, the equivalent for writing MIDI files,
MIDIFSave.cp/MFCheckEventList().

Add Boolean param. _playMaxDur_ to xxInsertEvent; if TRUE and we already have ??,
ignore the call to xxInsertEvent. Add FALSE as actual parameter to calls (in xxEndNoteLater)
value, so MIDI playback should behave the same as always => !#$^%&@$@# results in no
Note Offs being sent at all! How?

The 4th formal param. to CMEndNoteLater is now _long_ in the declaration, _short_ in
the prototype, & _UniqueMIDIID_(?) as the actual parameter -- very suspicious. Change
that to long in the prototype & declaraion of CMInsertEvent() => OK!! 

It's OK now _if_ the longer note is encountered first. If a shorter duration is followed
by a longer, it's not enough to add the longer one to the cmEventList: I have to remove
the shorter one! ...best implemented simply by replacing it (duration and Off velocity).
Do that => all OK!

-------------------------------------------------------------------------------

22-30 Dec.

- Ngale doesn't handle unisons, even perfect unisons, at all well. It'd be helpful
if user could say "unisons are OK". Then, (a) when they create a unison, (a) Ngale
should automatically put the new note on "the other side of the stem", and (b) Debug
Check shouldn't warn about perfect unisons. Fix est.impact: very low.

!! CAVEAT: aking _any_ change to Double.cp is likely to turn it into "ill-formed UTF"
(according to BBEdit); this is really nasty because Xcode doesn't complain, it just
gives compilation errors. I'm sure this has happened before, probably with a different
file. Sigh.

-------------------------------------------------------------------------------

2 - 3 Jan. 2016

Change name of the Preferences file from "Nightingale Devel Prefs" to "Nightingale AMNF
Prefs" (see entry for 16-17 Dec.) => gives the "Creating a new one" progress message,
but where is it? Finder's Search sez no "Nightingale AMNF Prefs" anywhere... Ah, unless
it's in a hidden folder!! Check w/ Terminal => success! Specifically:

  DonDualG5:~ donbyrd$ find . -name 'Nightingale A*' -print
  ./Library/Preferences/Nightingale AMNF Prefs

..right where it should be :-| .

Also, after creating (and using) a new Nightingale AMNF Prefs, Ngale complains that
field 69 (whichMIDI) is illegal; its value is 4. I.e., the prototype in the .rsrc (CNFG
resource) has it as 4, but the only legal values now are 0 and 1. Change that field in
.rsrc to 0 => OK.

-------------------------------------------------------------------------------

11 - 15 Jan.

Convert files encoded in Mac OS Roman to UTF-8; replace "sustain on" char. in code
with 0xA1 (its codepoint in Sonata). Affects DrawObject, Menu, DebugUtils.

Convert file with CRLF line endings to Unix. Affects defs.h.

The pedal mark (SUSTAINON) is now displayed as a digit "5"! It was OK in Ngale 5.5.
Cause: converting DrawObject.cp from Mac Roman to UTF8 screwed up the char. code;
in Sonata, it's 0xA1. Replace the char. in source code with 0xA1 => all OK again.

The standard "header" on Ngale .cp files says

 * THIS FILE IS PART OF THE NIGHTINGALE™ PROGRAM AND IS CONFIDENTIAL PROP-
 * ERTY OF ADVANCED MUSIC NOTATION SYSTEMS, INC.  IT IS CONSIDERED A TRADE
 * SECRET AND IS NOT TO BE DIVULGED OR USED BY PARTIES WHO HAVE NOT RECEIVED
 * WRITTEN AUTHORIZATION FROM THE OWNER.
 * Copyright © 1988-99 by Advanced Music Notation Systems, Inc. All Rights Reserved.

According to SourceTree's display of changes, the update to Double.cp I'm ready to
commit changes the char. after "NIGHTINGALE" from E-grave to TM, while the updates to
DrawObject, Menu, & DebugUtils change it from TM to comma / N-tilde / cent sign, and
add something like a "~" in front of the copyright symbol! Huh? Clearly related to
encoding. Encodings (according to BBEdit; ** = "Incorrectly formed") and chars. displayed
(BBEdit on my G5, default font; D-? = black diamond enclosing question mark):

file		old enc.		new enc.		char. after "NIGHTINGALE": ST	:BBE
Double		UTF8**			ISO Latin 1		E-grave => TM					D-? => super-a-underline
DrawObject	Mac OS Roman	UTF-8			TM => comma/N-tilde/cent sign	TM => TM
Menu		Mac OS Roman	UTF-8			TM => comma/N-tilde/cent sign	TM => TM
DebugUtils	Mac OS Roman	UTF-8			TM => comma/N-tilde/cent sign	TM => TM

It looks like BBEdit on Mac doesn't display Latin-1 properly (no surprise) and
SourceTree on Mac doesn't display UTR-8 properly (weird). Anyway, almost certainly not
evidence of a serious problem!

-------------------------------------------------------------------------------

21 Jan.

Showing attaching point(s) of symbols isn't as good as it used to be. I'm pretty sure
that formerly, double-click various symbols (at least dynamics, slurs, & GRString &
GRLyric Graphics) & hold mouse button formerly => showed attachment point(s) (via
vertical dotted lines, with call to UIFUtils.cp > HiliteAttPoints (or possibly
HiliteInsertNode?)); anyway, I want it to! Currently, it does so only for Graphics and
tempo marks, and only _after_ you release button on double-click, while the resulting
dialog is on screen: that's OK -- and quite possibly what it's always done for Graphics.
But it doesn't do it for dynamics and slurs at all. In fact, now that double-clicking
dynamics brings up an edit dialog, it could behave the same as for Graphics and tempi.

CheckDYNAMIC(), case SMDblClick, calls HiliteAttPoints():

	if (IsHairpin(pL))
		HiliteAttPoints(doc, firstSync, lastSync, staffn);
	else
		HiliteAttPoints(doc, firstSync, NILINK, staffn);

It looks like this should work. But CheckGRAPHIC(), case SMDblClick, for text, calls
HiliteInsertNode():

	HiliteInsertNode(doc, p->firstObj, staffn, TRUE);		/* Hiliting on */

...and so does CheckTEMPO(), case SMDblClick! It looks like HiliteInsertNode() works and
HiliteAttPoints() doesn't.

Change CheckDYNAMIC(), case SMDblClick, to use HiliteInsertNode => it works!

-------------------------------------------------------------------------------

2-31 Jan.

Can I make spacers more useful, e.g., for my projected double-stop crossing tremolo glissandi
w/ multiple open strings? Maybe.

Want to make the "Can't find Prefs file: creating a new one" message stay on the screen
longer, say for 5 sec. It _should_ just be a matter of increasing the argument to
SleepTicks() in Initialize.cp/OpenSetupFile, but that doesn't seem to have any effect?!?
Well, Initialize.cp is a mess, anyway; clean it up => now the message _does_ stay for
the time I specify! Weird, but not worth worrying about.

-------------------------------------------------------------------------------

8 Feb. - 1 March

- In some very recent scores -- my SpacerTest_InvisibleNotesBug.ngl &
3rdMovementFS_??.ngl and something of Glenn Gass' -- inserted notes aren't drawn at
all! With SpacerTest_InvisibleNotesBug, I tried redrawing, changing system spacing and
staff size (in Master Page); nothing makes the notes appear, and Debug has no
complaints. The invisible notes can't be selected graphically, but Select All highlights
what look like their correct positions. Save, re-Open it => no change. Strip it down to
InvisibleNotesBug.ngl => no change. ?!? Play => the invisible notes are played.

Dump InvisibleNotesBug.ngl => objRect.left is 0 iff note is invisible! Why? DrawSYNC()
is never called for the invisible notes. Why? Ihe Syncs' _visible_ flags are set, but
their _valid_ flags aren't! Why? Notes currently are invisible iff they're on the 2nd or
4th system; inserting new notes => the same thing. Insert a barline on sytem 2 or 4 =>
all notes on the system suddenly appear! Ah, in DrawScoreRange(), _drawAll_ is FALSE
for the invisible notes! For Measure objects, 

	if (SectRect(&pMeasure->measureBBox, &paperUpdate, &result)
											|| outputTo!=toScreen)

...then drawAll is set to FALSE. Clearly  outputTo==toScreen, so the problem is Ngale
thinks the intersetion of the measureBBox and the update area is empty. Why? Because the
measureBBox.left = measureBBox.right = 850, which I'm pretty sure is the right end of
the System! Why? I dunno, but let's add to Debug Check a check for Measures with
zero-width bbox that aren't immediately followed by a Page or System, or that have
something other than a Page before the next System. Add code to DCheckMBBox() => done.

On my G5, just adding a barline in the offending systems fixes everything in all test
scores, and in Glenn's score (filename _stems_), only the 2nd system is a problem
anyway. On Glenn's system, _none_ of the noteheads are drawn in either system, and
adding a barline does nothing! The apparent cause: he's using Sonata, and it doesn't
show up in Font Book, so it's evidently not installed properly -- and he doesn't have
Briard or Blue Notz. ??


-------------------------------------------------------------------------------

11 Feb.

Changing to a larger "paper" size via Page Setup seems to do nothing at all. I don't see
anything in Ngale code that explains this; info returned from the Page Setup dialog indicates
the paper size is unchanged !*(!*@&(. Changing from portrait to landscape format _does_
work. This is with Ngale 5.5 or 5.6b2 on my G5. But Opus says it works for him!; he's
running Ngale 5.3.0 b10m on OS 10.6.8. Try Ngale 5.5 on my old MacBook => changing paper
size works! So it looks like this is OS dependent.

-------------------------------------------------------------------------------

4-5 Mar.

- Piano pedal up and down symbols don't come out in a music font. However, the same
chars. as part of a text Graphic _are_ rendered in a music font.  Cf.
PedalSymbolsFontBug.ps to PedalSymbolsFontKludge.ps: the former, using Ngale's official
pedal symbols, switches to Helvetica for them! The latter, using text with the proper
chars. in the Sonata font, does _not_ switch. Why does Ngale switch to Helvetica instead
of using the music font? Because the calls to PS_FontString() in DrawGRAPHIC() for
GRMIDISustainOn and GRMIDISustainOff specify as the font
doc->fontTable[p->fontInd].fontName ; it should be just  doc->musFontName :-) .

-------------------------------------------------------------------------------

25-28 Mar.

Rename the _string_ field of the Graphic object to _strOffset_.

Getting the string stored in a Graphic object is extremely error prone! Does the
FirstGraphicSTRING macro handle this?

Rename the Tempo object fields containing STRINGOFFSETs to _xxxOffset_.

-------------------------------------------------------------------------------

28-29 Mar.

Check Range complains about double-bass notes that are indeed below its specified range
_if_ sounding pitch is interpreted as an octave below written -- but I'm using sounding
= written, and it plays back that way. Does it depend on if "Play from parts' settings"
is in effect? No. Cf. UseMIDINoteNum(), which is called from GetNotePlayInfo().

Want to support pure C scores (e.g., my violin concerto  and conventional
transposed scores and play either w/ specified patches (multi-channel) or all on one
channel =>  Ngale needs an explicit indication of whether it's a C score or not! Oops: 
it already has one!!: the "Transpose" MIDI command. Maybe rename it to "C Score"?
Anyway, the problem with Check Range results from it not paying attenion to that
setting. Cause: for transposing instruments, the parts' _hiKeyNum_ and _loKeyNum_ are
the MIDI note numbers of the written pitches, not the sounding pitches! Ugh. So, leave
that as is and change the Check Range code, or make them the note nos. of the sounding
pitches? The latter is obviously the correct fix; it's also obviously harder, and will
make the existing UI a bit clumsier (in terms of clefs displayed).. Need to
change the instrument descriptions, in STR# 130. That won't help existing scores!, but
they can be fixed one part at a time, and it won't make things any worse if they
aren't fixed.

Edit STR# 130... the format is obscure, and Ngale is very picky! Cf. MPImportExport >
SDInstrDialog(). But where is it read in? Ah, in InstrDialog, which also documents
the format.

-------------------------------------------------------------------------------

12 April - 23 June

Paste Merge, Set Duration, and Remove Rhythmic Gaps/Resynchronize sometimes give a
strange error message. E.g., Paste Merge a chord for piano in 3rdMovementFS.ngl, m. 32
=> "FixGRDrawLinks: for 1155, firstObj=1157 or lastObj=1161 isn't a Sync or a GRSync."
True, while 1157 is a Sync, 1161 is a Measure. Still, this makes no sense! Typically the
GRDraw Graphic in question is nowhere near the where I'm Paste Merging. In this case,
GRDraw Graphic w/ LINK 1155 is in m. 89. ?? Reconstruct/FixGRDrawLinks() is called only
from FixNBJDLinks(). ??

A similar case: "FixGRDrawLinks: for 1248, firstObj=1251 or lastObj=1255 isn't a Sync or
a GRSync."  1255 is a Measure. Ah, FixGRDrawLinks() is called from FixNBJDLinks() from
FixCrossPtrs(), and the latter has it work on the entire score! -- huge overkill. More
important, is there really a problem with these GRDraw objects? The only GRDraw objs we
have are lines, and they can be inserted only w/ Syncs or GRSyncs on both ends -- but if
one crosses a barline, Reformat can truncate it and attach the right end to a Measure! I
don't think this causes any problems, but maybe Debug Check should complain about it;
anyway, Paste Merge etc. probably shouldn't.

-------------------------------------------------------------------------------

20-21 April

We want extracted parts to have a different staff size from the score; staves in parts
should usually be larger! UI could be a new Config field, or -- probably better and
definitely lower impact -- entered in the Extract dialog. (Having both would be useful,
but low priority.) Re functionality, cf. Extract > CopyDocFields(); is it just a matter
of setting part->srastral to a different value? Nope! That doesn't result in updating
the actual size of each staff, H and V coords. of everything, etc. Ah, MasterPage >
DoMasterStfSize() seems to do everything needed. To be continued.

-------------------------------------------------------------------------------

10 - 26 June

This is utterly bizarre, but for a long time, Xcode 2.5 on my G5 has been unable to save
about three source-code files: Browser.cp, Dragging.cp, DebugUtils.cp; maybe others?
They're not locked. I've been opening them in BBEdit (not copying and pasting,
though that'd surely work as well) and editing and saving them with it for months, with
no problems at all.

I haven't tried on another machine or with Xcode 3.2 yet. Maybe it's a problem with the
Xcode project, and removing them from the project and re-adding them would fix this? No,
it doesn't help... but when you a file, Xcode asks what the encoding is. Maybe it's
confused about that? Yes!! -- Re-add them and specify correct encoding => all OK!

-------------------------------------------------------------------------------

14 June

For adding cues to parts, I need a way to change the number of measures on a multibar
rest... Oops, it can already be done via Get Info; not too obvious, but if Dur is
negative, it's the no. of measures!

-------------------------------------------------------------------------------

15 June

During MIDI playback, I recall Ngale draws the "next" page only if virtually none of
that page is in view yet; if even a tiny sliver of the page is already on the screen, it
doesn't "turn the page". This seems to be backwards! That might have made sense 15 years
ago when screens were much smaller and computers much slower, but now, Ngale should turn
the page if more than a tiny sliver is _not_ on the screen. This _should_ just be a
matter of changing the test, presumably in MIDIPlay.cp>PlaySequence(). The variables
_pageTurnTOffset_, _tBeforeTurn_, _newPage_ must have something to do with it. Ah,
_doScroll_ is the key! Scrolling is actually in HiliteSyncRect(). To be continued.

-------------------------------------------------------------------------------

28 June - 5 July

The cadenza of my Violin Concerto has two staves for the soloist, one for the viola
obbligato. I now have all the violin notes on one staff, so want to delete the 2nd staff
of the violin -- but I can't, because the only way to do that is to Split Part, then
delete the new part that contains the 2nd staff, and I can't Split Part because (the
error message says) there are notes in the default voice for the 2nd staff on the 1st
staff. Huh??

Make Ngale allow Split Part in that situation => the voice table changes from

   iVoice 1 in part 1 Role=L relVoice=1
   iVoice 2 in part 1 Role=U relVoice=2
   iVoice 3 in part 2 Role=. relVoice=1

to

   iVoice 1 in part 1 Role=. relVoice=1
   iVoice 2 in part 2 Role=. relVoice=1
   iVoice 3 in part 3 Role=. relVoice=1

This looks correct, but it's not: iVoice 2 still belongs to part 1! ...Ah, I see.

If a multistaff part has default voice(s) in use -- with notes, rests, or grace notes --
on staves other than their "native" staves, splitting requires creating a new voice for
each such voice. But if a multistaff part has _any_ voice in use on two or more staves,
splitting it would be very messy; not worth supporting, at least for the near future.
OK, but if the part doesn't have that feature and it's split, should we (1) change the
internal voice no. of the default voice in use on a non-native staff and keep iVoice
always = staff no., or (2) keep the iVoice of the voice in use and accept iVoice may not
= staff no.? Either way could be difficult. Ah, comments in VoiceTable.cp make it clear
iVoice must always = staff no.!

So the voice table for the Cadenza _must_ end up (except for the roles)

   iVoice 1 in part 1 Role=. relVoice=1
   iVoice 2 in part 2 Role=. relVoice=1
   iVoice 3 in part 3 Role=. relVoice=1
   iVoice 4 in part 1 Role=U relVoice=2

...and everything in iVoice 2 must change to iVoice 4.

But experiments aren't encouraging. This still might take a lot of work to get right --
and actually it shouldn't take long to move everything in violin voice 2 to voice 3
(after removing slurs/ties & beams); Split; and move everything in violin voice 3 back
to 2!  To be continued.

-------------------------------------------------------------------------------

9 July - 15 August

For Issue #98, it'd be great if the Tempo/Metronome Mark dialog could handle return
chars. the way the text-entry (for Graphics) dialog does.  Cf. TextDialog.cp/MyFilter
to DialogsEditor.cp/TempoFilter.

Pull a new function DrawStringBlock() out of DrawGRAPHIC().

One (of many!) problems along the way: To draw on screen, DrawStringBlock() needs the
font ID, but to draw PostScript, it needs the font name. How to get one from the other?
I don't think we have a routine to do that; how can it be done? Ah, doc->fontTable lets
you convert from one to the other, and I think _every_ font used in a score has an entry
in it! So implement FontID2Name() => OK.

OK, for Tempo objects, DrawTextBlock() now divides the tempo string at occurrences of the
"start new line" code and draws each separately -- but we also need to subdivide the string
to compute the Tempo's bounding box, and to know how far to the right to position the
M.M.! It's probably best to have DrawTEMPO() immediately convert the tempo string into
an array of single-line strings.  NB we're not doing anything like that w/ Graphics!
But they don't need such attention because (1) their embedded CRs automatically move to
the next line, and (2) they're simpler, i.e., they have nothing like the Tempo's M.M.
component.

No, that's way too messy. Instead, have TempoDialog() convert the "new line" char. to CH_CR
when it's OK'd, and vice-versa when it's opened w/ an existing tempo string => it works!

-------------------------------------------------------------------------------

28 Aug. - 1 Sept.

Why did Laurie have to change a bunch of goto's and cases in switches to get Ngale to
compile w/ Xcode 7.3? As http://www.cplusplus.com/forum/general/168196/ says: "A jump
to a labelled statement (case xxx and default are labelled statements) is not permitted
to bypass the initialisation of an object a variable." Files needing changes: About.cp,
CheckMerge.cp, DrawObject.cp, DurationPopUp.cp, FileInput.cp, NavServices.cp.
(The change she made in Menu.cp was commenting out code for a different reason.)

-------------------------------------------------------------------------------

23 - 24 Sept.

Doug McK. reports that he can't open his old files w/ Ngale 5.6, files that don't have
the proper Ngale document icon, via the Open command -- no surprise. But trying to
open them by dropping on the Ngale program icon gives

	Nightingale can't open the file.
	The file version is '

Not too helpful! It looks like this is from StopInform(370); 370 is READ_ALRT. The 2nd
line must be STR# 241 string 7, 8, or 9: all begin with "The file version is '", then
go on to say more; it's not clear why that's all StopInform() sends out. Where is that
StopInform()?

Test w/ my file "Things th MaUs Sing full p.ngl copy": sure enough, it behaves the way
Doug says. Add a LogPrintf at start of OpenError() => never prints anything! ?? Ah,
dropping files on the program icon calls FSpecOpenDocument(); it notices the file has
the wrong document type, but gives the wrong error message!

-------------------------------------------------------------------------------

12 - 13 Oct.

I want to change my violin concerto from _absolute_ C score (not even octave
transposition) to normal C score (piccolo sounds 8va above written, bass sounds 8va
below). Ngale doesn't have a "normal C score" option, but using the octave-transposed
clefs works OK for piccolo, which plays only briefly a couple of times anyway. But for
bass, while it gets rid of ledger lines below the staff for very low notes, it adds
even more ledger lines _above_ the staff for very high notes! #^)@&$*)#%1=  Of course
the standard solution for bass is to switch to tenor clef for very high notes, but Ngale
doesn't have an octave-transposed tenor clef, sigh. How hard would it be to add?

The enum for clef types, excluding PERC_CLEF, goes from highest (TREBLE8_CLEF) to lowest
(BASS8B_CLEF) in order. Want to keep the order, but adding TENOR8_CLEF would change
the code(s) for clefs after that. What about co-opting the code for baritone clef,
which is almost never used?

-------------------------------------------------------------------------------

17 - 20 Oct.

Implement Nudge (move a single selected symbol of some types with command-arrowkey) =>
wonderful when it works! But, while it works well (A) for some symbol types, it works
less well or not at all (F) for others.

* A	Text graphics
* A	Notes/rests			+ Should affect just selected notes/rests, not the entire Sync!
* A	Dynamics			+ Up/down has no effect whatever!?
						+ For hairpins, affects only the left end
* A	Tempo/metro marks
* F	Tuplets				- None of the keys has any effect
* F	Ottavas				- "  "
* F	Slurs/ties			- "  "

It'd be nice to be able to nudge tuplets, ottavas, but not worth doing now. Slurs are
more important, but we really need to nudge individual endpoints and control points -- which
is a different proposition.

-------------------------------------------------------------------------------

24-25 Oct.

Apparently the Print command sometimes -- for Doug McKenna, consistently -- generates
PostScript output instead of bitmap! How is that possible? Actually, it's not obvious
how the Print command ever prints anything! NDoPrintScore() doesn't actually print
anything, and all the Print command does explicitly is to call NDoPrintScore().

Somehow we get to DrawScoreRange(), which is called only from DrawRange(), which (for
the score proper, as opposed to Master Page) is called only from DrawPageContent().
??

-------------------------------------------------------------------------------

1 Nov.

It's worth some time on supporting tweaking slur position _somehow_, either with Get
Info or nudging. The object xd is currently always set to 0 but ignored, so I could just
make slur-drawing and -dragging code use it as an offset! -- well, not so easy; there's
also the code to drag anchor & control points. Much safer: change coordinates in each of
the anchord & control points; UI-wise and more user-friendly, this fits nudging better.

-------------------------------------------------------------------------------

14 Nov.

How about making (normal, 1-octave) ottava signs display "8va" or "8vab"? Definitely
preferable a lot of the time -- probably most of the time -- but there are cases where
just "8" is better. How hard would it be to offer a choice? It'd be very nice to have "8va"
on the "Questionable Symbols" OMR test page, anyway; just kludge it for that?

-------------------------------------------------------------------------------

15-20 Nov.

I'd like to look for differences two versions of the violin solo part of the concerto,
1st mvmt part 1, by doing text comparison of their notelists; but that's useless because
the start times are all different by 3840 bcs in one of the original files,
1stMovement_Part1-VnSolo.ngl, the 1st visible barline has time 1920, while in the other
it's the correct value 5760 bcs of the preceding multibar rest, so have 1444 diffs. in
the notelists!  Logical times are computed by SpaceTime.cp>GetSpTimeInfo(), which calls
CalcNoteLDur() ?!? -- whose comment says "for multibar rests of ANY number of
measures..., return one measure's duration"; but why?? And a vn part extracted from
1stMovement_Part1.ngl w/ Ngale 5.7b6 gives the rest the proper duration, obviously bcs
Extract() does the right thing; 1stMovement_Part1-VnSolo.ngl could have ended up w/ the
wrong value bcs of my fiddling w/ the initial multibar rest after extracting the part!

Fixing CalcNoteLDur() to handle multibar rests shouldn't be hard, but impact? Well,
multibar rests almost never occur outside of extracted parts, and changing the
calculated duration of one can't affect syncing, etc., so realllly shouldn't be a
significant problem.

OK, done; but there are still 137 differences in the notelists! *#$@$)(!#  A fair no. are
because of initial clefs on systems (since the system breaks are different). Why should
notelists include initial clefs? Surely most of the time users wouldn't care anyway, &
should be easy to skip them. Initial keysigs are already skipped, thanks to Tim C.

OK, done => down to 123 differences.

There's a 4-bar rest just before the 1st cues that should be 5 bars! => fixed.

Make tempo marks omit metronome mark when _noMM_ is set, keep multiline tempo marks on one
notelist line, etc. => down to 109 differences.

Other changes... => down to 62 differences! A lot of these are bcs of cues I added to
1stMovement_Part1-VnSolo.ngl; some due to reformatting affecting text (extensions, etc.).

More changes => down to 59 differences. !! The main problem now is starting w/ m. 137, which
-- thanks to cues in the tweaked part -- Ngale thinks has a duration of 2400 when it should
be 1920. Clearly a bug resulting from the clef change in the cues. Kludge around that =>
Ngale has the correct duration for m. 137 => only 28 differences!, and they all seem to be
legitimate.

-------------------------------------------------------------------------------

21-22 Nov.

I want to find measures that are incomplete on a given staff (as opposed to measures that are
incomplete or overfull across all staves, ala Show Duration Problems). The nicest UI by far
seems to be doing roughly what Show Duration Problems, but just shading the measure on the
relevant staff. Might as well have Show Duration Problems turn this on/off also!

Cf. DrawObject/ShadeProblemMeasure().

-------------------------------------------------------------------------------

8 Dec.

With the latest Ngale (5.7b8), Extracting the bassoon part of 3rdMovement.ngl crashes, at
the call to InitMeasure() at the end of MakeMeasure(). This looks like the same bug I ran
into in May (Issue #58).

-------------------------------------------------------------------------------

1 Jan. 2017

The "standard" notation for artificial harmonics -- as recommended in _Behind Bars_, and
as seen in the Schoenberg Violin Concerto -- involves showing the sounding pitch with a
small notehead, in parentheses, a bit to the right of the stopped/touched pitch "dyad".
It's almost impossible to fake that in Ngale now, but it'd take a lot of work to
implement properly; besides, I think it's ugly, and I haven't actually seen it used in
many published scores at all. But something to help with _some_ kind of notation
explicitly showing stopped, touched, and sounding pitches would be very nice! And of
course it should play back properly. The best such non-ugly notation I can think of is
to add to the stopped/touched dyad a small notehead, preferably in parentheses, at the
sounding pitch; the small notehead would have the regular velocity, the stopped &
touched noteheads velocity 0.

Ignoring the parentheses for now, ideas: (1) add a command to take a single note
(sounding pitch); assuming the interval between stopped and touched pitches is a 4th(?),
it adds two lower notes of same duration with velocity 0, makes the top note small, and
the middle one of the three notes diamond shape.

Or maybe (2) the command takes a 3-note chord; makes the top note small, sets the lower
notes to velocity 0, and the middle one to diamond shape. Not as nice or helpful, but
considerably easier to implement!  Cf. MakeArtificialHarmonic.txt .

-------------------------------------------------------------------------------

5 Jan.

Trying to save MIDI files of my five violin concerto files, no problem with the first
two, but then Ngale keeps either writing garbage MIDI files (though they're playable,
and recognizable as the right music) or crashing! This is with the current Ngale 5.7b8,
running "inside" Xcode. Ngale 5.7b7 does better, but not _that_ much better. ?!? From
the log file when it doesn't crash:

	...
	Jan  5 11:06:30 DonDualG5 Ngale[64320]: WARNING: Tempo change in measure 187 at same time as a previous tempo change.
	Jan  5 11:06:30 DonDualG5 Ngale[64320]: WARNING: Tempo change in measure 192 at same time as a previous tempo change.
	Jan  5 11:06:30 DonDualG5 Ngale[64320]: WriteTrackName: staff=1 name='@û'
	Jan  5 11:06:30 DonDualG5 Ngale[64320]: WriteTrackPatch: staff=1 patch=1
	...

The last messages are WriteTrackName, WriteTrackPatch, and WriteMFNotes for staff=15 name='Cello'
-- oops, it should be double bass!?! Ah, the "staff" numbers are 1 too high because they're
really track numbers; even though doesn't seem to have crashed, it didn't get to the last staff
-- and the log file continues with stuff like:

	Jan  8 14:48:19 DonDualG5 ReportCrash[37243]: Formulating crash report for process quicklookd[37241]
	Jan  8 14:48:20 DonDualG5 Dock[146]: [QL ERROR] quicklookd crashed while thumbnailing /Users/donbyrd/Documents/2ndMovement.ngl.mid
	Jan  8 14:48:20 DonDualG5 Finder[152]: [QL ERROR] quicklookd crashed while thumbnailing file://localhost/Users/donbyrd/Documents/2ndMovement.ngl.mid
	Jan  8 14:48:20 DonDualG5 com.apple.launchd[128] (com.apple.quicklook[37241]): Exited abnormally: Bus error

When Ngale does crash:

	...
	Jan  5 11:08:23 DonDualG5 Ngale[64320]: WARNING: Tempo change in measure 189 at same time as a previous tempo change.
	Jan  5 11:08:23 DonDualG5 Ngale[64320]: WARNING: Tempo change in measure 206 at same time as a previous tempo change.
	Jan  5 11:08:34 DonDualG5 ReportCrash[64364]: Formulating crash report for process quicklookd[64352]
	Jan  5 11:08:34 DonDualG5 ReportCrash[64364]: Formulating crash report for process Nightingale[64320]
	Jan  5 11:08:36 DonDualG5 Finder[28098]: [QL ERROR] quicklookd crashed while thumbnailing file://localhost/Users/donbyrd/Documents/3rdMovement.ngl.mid
	...

This suggests the problems, or at least the crashes, aren't Ngale's fault. ??

Log out & back in; try 5.7b6 on 3rdMovement.ngl => another crash, with log:

	Jan  5 11:23:00 DonDualG5 Ngale[64713]: WARNING: Tempo change in measure 189 at same time as a previous tempo change.
	Jan  5 11:23:00 DonDualG5 Ngale[64713]: WARNING: Tempo change in measure 206 at same time as a previous tempo change.
	Jan  5 11:23:06 DonDualG5 ReportCrash[64721]: Formulating crash report for process Nightingale[64713]
	Jan  5 11:23:08 DonDualG5 ReportCrash[64721]: Saved crashreport to /Users/donbyrd/Library/Logs/CrashReporter/Nightingale_2017-01-05-112300_DonDualG5.crash using uid: 502 gid: 502, euid: 502 egid: 502
	Jan  5 11:23:08 DonDualG5 com.apple.launchd[118] ([0x0-0x7a77a7].com.amns.nightingale[64713]): Exited abnormally: Bus error

I almost certainly used 5.7b7 to generate the previous set of five MIDI files, w/ no
problems; that also suggests it isn't Ngale's fault! Reboot, try again => crashes.

Copy concerto Ngale files to MacBook 3; try 3rdMovement.ngl there w/ Ngale 5.7b8 =>
crashes; w/ Ngale 5.7b6 => another garbage MIDI file, different from a previous version.
It sounds as if the garbageness is because note times are scrambled, starting within the
first few seconds. %^&()##$@)+  Listen more closely to the new garbage file => it's OK!!! 
Maybe part of the problem is w/ QuickTime on my G5 -- but that doesn't explain the
crashes. ?!?

The crash seems to happen consistently w/ 3rdMovement.ngl, less consistently w/ other
files.

28 Jan.-1 Feb.

This bug is now Issue #123. But it bug seems to be totally gone! I haven't touched the
Import MIDI File code, but I exported each of the five chunks of the violin concerto,
the 3rd mvmt twice, with no problems!! Then I did them all again, in reverse order, w/
5.7b8 => no problems. Looks like I was "chasing a ghost", which isn't hard to believe in
view of the issues mentioned above. Try again w/ 5.7b6: open all five sections; export
1stMovement_Part1.ngl => no problem; 1stMovement_Cadenza.ngl => crashes ^#$%^(#$%!*%^ .
No, it's a bug, not a ghost! Part of traceback in Problem Report:

	Thread 0 Crashed:
	0   libSystem.B.dylib             	0x969ff7c8 strlen + 8
	1   libSystem.B.dylib             	0x96a94edc __vfprintf$LDBL128 + 16332
	2   libSystem.B.dylib             	0x96ad51cc vsprintf$LDBL128 + 228
	3   com.amns.nightingale          	0x0001b414 LogPrintf(short, char const*, ...) + 80
	4   com.amns.nightingale          	0x000ce2cc SaveMIDIFile(Document*) + 2508
	5   com.amns.nightingale          	0x00009a30 DoFileMenu(short) + 844
	6   com.amns.nightingale          	0x0000bd60 DoMenu(long) + 232

W/ 5.7b8, open all five sections; export 1stMovement_Part1.ngl => crashes, w/ traceback
identical to the above except for slightly different offset in SaveMIDIFile()  :-( . From
log file:

	Jan 29 09:17:51 DonDualG5 Ngale[27919]: WARNING: Tempo change in measure 173 at same time as a previous tempo change.
	Jan 29 09:17:51 DonDualG5 Ngale[27919]: WARNING: Tempo change in measure 198 at same time as a previous tempo change.
	Jan 29 09:17:58 DonDualG5 com.apple.launchd[1] (org.postfix.master[27914]): Stray process with PGID equal to this dead job: PID 27915 PPID 1 pickup
	Jan 29 09:18:10 DonDualG5 ReportCrash[27928]: Formulating crash report for process quicklookd[27929]
	Jan 29 09:18:12 DonDualG5 ReportCrash[27928]: Formulating crash report for process Nightingale[27919]
	Jan 29 09:18:12 DonDualG5 fseventsd[42]: callback_client: ERROR: d2f_callback_rpc() => (ipc/send) timed out (268435460) for pid 27919

Hmmmm -- WriteTrackName() calls LogPrintf() w/ an unintialized variable for a string
pointer! Could that be the problem? Fix it; open all five chunks; Export MIDI Files =>
no crash, but 1stMovement_Part1 & _Part3 have the scrambled note times problem :-( .

According to our Import MIDI File, 1stMovement_Part1_TRASHED.mid contains 3812 notes, while
1stMovement_Part1_OK.mid contains 3830!! Why? On a track-by-track basis, one track has 2 more
notes in the trashed version; others have the same number, or from 1 to ca. 3 fewer. Why?
1stMovement_Part3_TRASHED.mid contains 2640 notes, while 1stMovement_Part3_OK.mid contains
2641. ??

Very few of the functions in MIDIFSave.cp that actually write to the file check FSWrite()'s
return value for errors. Add checking to all, experiment more => after saving each of the five
concerto chunk MIDI files two or three times, no more bad MIDI files, and no errors detected.
Which proves nothing.

What else could be the problem? Ah, we're using pointers to Ngale objects in places where
memory could have moved without locking the HEAP, e.g., in WriteTrackName(); that could
lead to occasional crashes or strange behavior! ...Fixed all of those. Export all five concerto
chunks, PianoSonataMvmt, 2 violin duets, concerto chunks again => all OK! -- except that
Issue #114 is back!: While patch settings properly affect MIDI playback inside Ngale,
they have no effect on MIDI files Ngale writes. ??

-------------------------------------------------------------------------------

22- Jan.

"Measure duration/timestamps too large" bug is because, in FixMeasTimeStamps(), the value of
spTimeInfo[last].startTime is sometimes too large -- but not always, and if it is, not always
by the same amount! Open CalcLDur.ngl; delete whole rest in m. 3; re-insert it => 
sometimes spTimeInfo[last].startTime = 960 (correct), sometimes it's 1140, sometimes 1200!
So it's GetSpTimeInfo() that's misbehaving... Yes. Why? Because the whole rest doesn't always
get added to the 1st Sync of the measure! This could be WAD if Insert by Position was checked,
but it isn't. @#$#%^^!*# Is this worth fixing now? Maybe not.


Re discussion of artificial harmonics above for 1 Jan., #2 is almost certainly the way to go.
Cf. MakeArtificialHarmonic.txt . For UI, how about adding to QuickChange(TM)

	Change [3-note chord] to artificial harmonic 

-------------------------------------------------------------------------------

2-3 Feb.

I _think_ the Export MIDI File crash/trash bug is fixed, but now patch changes again aren't
working! @#)#$%#))%^  I fixed this in 5.7b5 just a few months ago! Test w/ Concerto
1stMovementPart1 & 5.7b6 => OK; w/ 5.7b8 => OK; w/ MIDISave.cp of 8 Jan., of 31 Jan., of 1
Feb., of 2 Feb. AM => all OK. So either I just broke this or it's a ghost! Test w/ latest
MIDISave.cp => still OK, so it's a ghost :-| .

-------------------------------------------------------------------------------

4-20 Feb.

Work on some "inadequate screen redrawing for dragging and/or nudging" bugs:

-1. Graphics (normally text) attached to the page: dragging gives feedback by showing
the bounding box moving around, then -- when you stop -- it draws the Graphic at its new
location. Not ideal, but good enough. But for nudging, the "feedback" is redrawing the
music area, which almost never contains the Graphic: pretty dumb looking! To fix, have
InvalSelRange check if anything selected is attached to the page, and if so inval the
entire window. Also not ideal: it'd be much nicer to just Inval the page; could I
implement that quickly & reliably?

-2. "Normal" Graphics: feedback for both dragging and nudging redraws only the Measure the
Graphic belongs to, but the Graphic often extends into the previous or the following
Measure. (And it sometimes extends even further, but that's rare enough to ignore.)

-Tempo marks, ottavas, and  slur/ties: feedback for dragging sometimes redraws
enough, but for nudging and sometimes for dragging, it redraws only the Measure. ??Actually,
feedback for dragging tempos sometimes works for the next measure as well, or even the
entire part of the system to the right! ??

-A good-enough (I think) solution: In all cases(?), after dragging and after each nudge,
redraw the previous Measure as well if it's in the same system; likewise for the
following Measure.

-3. Dynamics & modifiers: feedback for dragging covers a large enough area, but doesn't erase the
previous positions, so it leaves a trail! For nudging, redrawing the previous and next
Measures (if in the same System) is good enough.

-------------------------------------------------------------------------------

13 Feb.

Work on the "Consecutive measures of rest in extracted parts aren't combined into a
multi measure rest" bug (Issue #111)

The original description of the Issue (Aug 25, 2016):

In some cases, consecutive measures of rest in extracted parts aren't combined into a
multi measure rests, and for no obvious reason, e.g., there's no change of time
signature. Examples in my Violin Concerto include 1st mvmt Part 1, piano, mm. 195-199;
3rd mvmt, trumpet, mm. 75-79. In both of these, there's a system break in the score in
the middle of the area; could that be the reason?

Another theory. In both of the above-cited cases, a tempo mark is attached to the 1st
measure that's not merged into a multi measure rest. Is that the problem? Maybe part of
the problem: deleting the tempo mark in I, m. 195 results in the extracted piano part
going one measure further! Ah, of course: we continue multibar rests only as long as the
extracted part contains _nothing_ but normal single barlines and whole measure rests.
But why does the multibar rest still stop at m. 196? Because there's an invisible tempo
mark in that measure, attached to the solo violin part, but extracted anyway! This is
probably what I had in mind all along, i.e., thsi feature Works as Designed :-) .

-------------------------------------------------------------------------------

Early March

Replace (at long last!) our ridiculous timed-loop millisecond delay function with
something that uses gettimeofday()! It's been pointed out that timing something by
comparing values of gettimeofday() can fail badly if the OS decides to update the
time in the middle, but that's pretty unlikely for timing a few seconds or less, and
that's all Ngale ever does.

-------------------------------------------------------------------------------

9 March

Work on AddCautionaryTimesigs(). It's not hard to decide whether and where to add a
cautionary timesig, but how to actually add it to object list? It could just call
NewMeasure(), but might be better to mimic what NewMeasure() does to prepare, e.g.,
call GetContext(); then call CreateMeasure() to add the object.
